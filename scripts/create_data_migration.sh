#!/bin/bash

# ==============================================================================
# Скрипт для создания и выполнения кастомной миграции,
# которая создает суперпользователя и группы (роли),
# а также автоматически назначает им все необходимые права доступа.
# ==============================================================================

# 1. Определяем переменные.
APP_NAME="users"
MIGRATION_NAME="create_superuser_and_groups_with_permissions"
SOURCE_FILE="_data_migration_template.py" # Имя файла с кодом кастомной миграции.

echo "-> Запускаем создание пустой миграции..."

# 2. Создаем пустую миграцию с помощью Django.
# PDM автоматически подхватит виртуальное окружение.
pdm run python manage.py makemigrations ${APP_NAME} --empty --name ${MIGRATION_NAME}

# 3. Находим путь к только что созданному файлу миграции.
# `ls -t` - сортирует по времени, `head -n 1` - берет самый новый.
MIGRATION_FILE=$(ls -t apps/${APP_NAME}/migrations/*_${MIGRATION_NAME}.py | head -n 1)

# Проверяем, был ли файл создан.
if [ -z "$MIGRATION_FILE" ]; then
    echo "!! Ошибка: Не удалось создать или найти файл миграции. Прерывание."
    exit 1
fi

echo "-> Файл миграции успешно создан: ${MIGRATION_FILE}"
echo "-> Копируем код из ${SOURCE_FILE} в новый файл миграции..."

# 4. Копируем содержимое заготовленного файла в новую миграцию.
cat "${SOURCE_FILE}" > "${MIGRATION_FILE}"

if [ $? -eq 0 ]; then
    echo "-> Код успешно скопирован."
    echo "-> Готово! Можно запускать 'migrate'."
else
    echo "!! Ошибка: Не удалось скопировать код в файл миграции."
    exit 1
fi
