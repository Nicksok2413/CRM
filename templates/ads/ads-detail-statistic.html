{% extends "_base.html" %}

{% block content %}
<h2 class="fw-bold">Детальная статистика: {{ ad.name }}</h2>

<!-- Блок с KPI -->
<div class="row bg-white px-3 py-3 mx-2 my-2 rounded shadow-sm">
    <div class="hstack gap-3 pb-4">
        <a href="{% url 'ads:statistic' %}" class="btn btn-success p-2">
            <i class="fas fa-arrow-left"></i> К общей статистике
        </a>
    </div>
    <div class="col-md-3"><strong>Бюджет:</strong> {{ ad.budget|floatformat:2 }} руб.</div>
    <div class="col-md-3"><strong>Общий доход:</strong> {{ total_revenue|floatformat:2 }} руб.</div>
    <div class="col-md-3"><strong>Привлечено лидов:</strong> {{ total_leads }}</div>
    <div class="col-md-3"><strong>Активных клиентов:</strong> {{ total_active_clients }}</div>
    <div class="col-md-3"><strong>Рентабельность (ROI):</strong> {{ profit|floatformat:2|default:"-" }} %</div>
</div>

<!-- Таблица с лидами -->
<div class="row bg-white px-3 py-3 mx-2 my-4 rounded shadow-lg">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Список лидов</h4>

        <!-- Форма фильтра -->
        <form method="get" class="d-flex gap-2 align-items-center">
            {{ status_filter_form.as_p }}
            <button type="submit" class="btn btn-primary btn-sm">Фильтр</button>
            <a href="{{ request.path }}" class="btn btn-secondary btn-sm">Сбросить</a>
        </form>

    </div>

    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th>ФИО</th>
                <th>Email</th>
                <th class="text-center">Статус контракта</th>
                <th class="text-end">Сумма контракта</th>
            </tr>
        </thead>
        <tbody>
            {% for lead in leads_list %}
            <tr>
                <!-- ФИО -->
                <td>
                    {% if perms.leads.view_potentialclient %}
                        <a href="{% url 'leads:detail' lead.pk %}">{{ lead }}</a>
                    {% else %}
                        {{ lead }}
                    {% endif %}
                </td>

                <!-- Email -->
                <td>{{ lead.email }}</td>

                <!-- Статус контракта -->
                <td class="text-center">
                    {% if lead.active_contract %}
                        <span class="badge bg-success">Активный</span>
                    {% elif lead.contracts_history.exists %}
                        <span class="badge bg-secondary">Архивный</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">В работе</span>
                    {% endif %}
                </td>

                <!-- Сумма контракта -->
                <td class="text-end">
                    {% if lead.active_contract %}
                        {{ lead.active_contract.contract.amount|floatformat:2 }} руб.
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" class="text-center">Для этой кампании еще нет лидов.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}