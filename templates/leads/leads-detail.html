{% extends "_base.html" %}

{% load guardian_tags %}

{% block content %}
<h2 class="fw-bold">Детальная информация о лиде</h2>
<div class="row bg-white px-3 py-3 mx-2 my-5 rounded pb-5 shadow-lg">
    <div class="hstack gap-3 pb-4">
        <a href="{% url 'leads:list' %}" class="btn btn-primary p-2">
            <i class="fas fa-arrow-left"></i> К списку лидов
        </a>
    </div>
    <div class="col"></div>
    <div class="col-6"> <!-- Увеличим ширину центральной колонки для лучшего вида -->
        <div class="card border-dark shadow" style="background: #eee">
            <div class="card-body">

                {# Получаем объектные права для этого лида #}
                {% get_obj_perms request.user for object as "lead_perms" %}

                <!-- ================== ЗАГОЛОВОК И СТАТУС В ОДНУ СТРОКУ ================== -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title fw-bold mb-0">{{ object }}</h5>

                    {% if object.status == object.Status.NEW %}
                        <span class="badge bg-primary fs-6">{{ object.get_status_display }}</span>
                    {% elif object.status == object.Status.IN_PROGRESS %}
                        <span class="badge bg-warning text-dark fs-6">{{ object.get_status_display }}</span>
                    {% elif object.status == object.Status.CONVERTED %}
                        <span class="badge bg-success fs-6">Активный клиент</span>
                    {% elif object.status == object.Status.LOST %}
                        <span class="badge bg-secondary fs-6">{{ object.get_status_display }}</span>
                    {% endif %}
                </div>
                <!-- ==================================================================== -->

                <ul class="list-group list-group-flush">
                    <li class="list-group-item bg-transparent"><strong>Телефон:</strong> {{ object.phone|default:"Не указан" }}</li>
                    <li class="list-group-item bg-transparent"><strong>Email:</strong> {{ object.email }}</li>
                    {% if object.ad_campaign %}
                    <li class="list-group-item bg-transparent">
                        <strong>Источник:</strong>
                        <a href="{% url 'ads:detail' object.ad_campaign.pk %}">{{ object.ad_campaign.name }}</a>
                    </li>
                    {% endif %}
                </ul>

                <hr>

                <!-- Блок основных действий -->
                <div class="d-flex justify-content-center gap-2 mt-4">
                    {# Проверяем объектное право на изменение #}
                    {% if "change_potentialclient" in lead_perms %}
                        <a href="{% url 'leads:edit' object.pk %}" class="btn btn-primary">Редактировать</a>
                    {% endif %}
                    {# Проверяем объектное право на удаление #}
                    {% if "delete_potentialclient" in lead_perms %}
                        <a href="{% url 'leads:delete' object.pk %}" class="btn btn-danger">Удалить</a>
                    {% endif %}
                </div>

                <!-- Блок смены статуса (виден только если лид еще не конвертирован) -->
                {% if "change_potentialclient" in lead_perms and object.status != object.Status.CONVERTED %}
                    <h5 class="text-center mt-4">Действия с лидом</h5>
                    <div class="d-flex justify-content-center gap-2 mt-3">

                        {% if object.status == object.Status.NEW %}
                            <!-- Если статус "Новый", предлагаем "Взять в работу" -->
                            <form method="post" action="{% url 'leads:update_status' pk=object.pk status='IN_PROGRESS' %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning btn-sm">Взять в работу</button>
                            </form>

                        {% elif object.status == object.Status.IN_PROGRESS %}
                            <!-- Если статус "В работе", предлагаем "Активировать" -->
                            {# Проверяем право на создание активного клиента, оно глобальное #}
                            {% if perms.customers.add_activeclient %}
                                <a href="{% url 'customers:create_from_lead' object.pk %}" class="btn btn-info btn-sm">
                                    Активировать клиента
                                </a>
                            {% endif %}

                        {% elif object.status == object.Status.LOST %}
                            <!-- Если статус "Потерян", предлагаем "Вернуть в работу" -->
                            <form method="post" action="{% url 'leads:update_status' pk=object.pk status='IN_PROGRESS' %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success btn-sm">Вернуть в работу</button>
                            </form>

                        {% endif %}

                        <!-- Кнопка "Клиент потерян" видна всегда, пока он не конвертирован -->
                        {% if object.status == object.Status.NEW or object.status == object.Status.IN_PROGRESS %}
                            <form method="post" action="{% url 'leads:update_status' pk=object.pk status='LOST' %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-secondary btn-sm">Клиент потерян</button>
                            </form>
                        {% endif %}

                    </div>
                {% endif %}

            </div>
        </div>
    </div>
    <div class="col"></div>
</div>
{% endblock %}