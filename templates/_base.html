{% load static %}
{% load cache %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="{% static 'style.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- ================== FLATICKR CSS ================== -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- =================================================== -->

    <title>CRM</title>
</head>
<body>

<div class="main-container d-flex">
    <div class="sidebar" id="side_nav">
        <div class="header-box px-3 pt-4 pb-4">
            <h1 class="fs-4 nav-logo">
                <span class="text-black text-uppercase font-weight-bold">
                    <a class="link-dark text-decoration-none" href="/">CRM BACKOFFICE</a>
                </span>
            </h1>
        </div>

        <!-- ======================== БЛОК ПРОФИЛЯ ======================== -->
        {% if user.is_authenticated %}
        <div class="user-profile d-flex flex-column align-items-center p-3">

            <!-- Аватар или иконка по умолчанию -->
            {% if user.profile.photo %}
                <img src="{{ user.profile.photo.url }}" alt="Avatar" class="user-avatar rounded-circle mb-2">
            {% else %}
                <!-- Если фото нет, показываем иконку Font Awesome -->
                <span class="user-avatar-default mb-2"><i class="fas fa-user-circle"></i></span>
            {% endif %}

            <!-- Имя пользователя -->
            <span class="user-name fw-bold mt-2">{% firstof user.get_full_name user.username %}</span>

        </div>
        <hr class="mx-2 my-0"> <!-- Разделительная линия -->
        {% endif %}
        <!-- ==================================================================== -->

        {% comment %}
            Кэшируем блок меню на 1 час (3600 секунд).
            Ключ кэша будет зависеть от ID пользователя.
            Это значит, что у каждого пользователя будет своя собственная
            кэшированная версия меню.
        {% endcomment %}

        {% cache 3600 sidebar request.user.id %}
            <ul class="list-unstyled px-2">
                {% if perms.products.view_service %}
                <li><a href="/products/" class="bar-item text-decoration-none px-3 py-3 d-block">
                    <span><i class="fas fa-microchip"></i></span><span class="ml-1"> Услуги</span>
                </a></li>
                {% endif %}
                {% if perms.advertisements.view_adcampaign %}
                <li><a href="/ads/" class="bar-item text-decoration-none px-3 py-3 d-block">
                    <span><i class="fas fa-ad"></i></span><span class="ml-1"> Рекламные кампании</span>
                </a></li>
                {% endif %}
                {% if perms.leads.view_potentialclient or 'Менеджер' in request.user.groups.all|join:"," %}
                <li><a href="/leads/" class="bar-item text-decoration-none px-3 py-3 d-block">
                    <span><i class="fas fa-user-clock"></i></span><span class="px-1"> Лиды</span>
                </a></li>
                {% endif %}
                {% if perms.contracts.view_contract %}
                <li><a href="/contracts/" class="bar-item text-decoration-none px-3 py-3 d-block">
                    <span><i class="fas fa-file-alt"></i></span><span class="px-1"> Контракты</span>
                </a></li>
                {% endif %}
                {% if perms.customers.view_activeclient or 'Менеджер' in request.user.groups.all|join:"," %}
                <li><a href="/customers/" class="bar-item text-decoration-none px-3 py-3 d-block">
                    <span><i class="fas fa-user-check"></i></span><span class="px-1"> Активные клиенты</span>
                </a></li>
                {% endif %}
                <li>
                    <hr>
                </li>
                <li>
                    <!-- Оборачиваем кнопку в форму, отправляющую POST-запрос на URL выхода -->
                    <form id="logout-form" method="post" action="{% url 'logout' %}">
                        {% csrf_token %}
                        <!-- Кнопку стилизуем так, чтобы она выглядела как пункт меню -->
                        <button type="submit" class="bar-item text-decoration-none px-3 py-3 d-block btn btn-link text-start w-100">
                            <span><i class="fas fa-sign-out-alt"></i></span><span class="px-1"> Выход</span>
                        </button>
                    </form>
                </li>
            </ul>
        {% endcache %}

    </div>
    <div class="content px-3 pt-4">

        <!-- ================== БЛОК ДЛЯ СООБЩЕНИЙ ================== -->
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <!--
                    Класс алерта (alert-success, alert-warning и т.д.) берем из "тегов" сообщения.
                    Django автоматически присваивает теги 'success', 'warning', 'error', 'info'.
                    -->
                    <div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        <!-- ======================================================= -->

        {% block content %}{% endblock %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ================== FLATICKR JS =================== -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Локализация для русского языка -->
<script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js"></script>
<!-- ================================================== -->

<!-- ==================== CHART.JS ==================== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ================================================== -->

<!-- ================== КАСТОМНЫЙ JS ================== -->
<script src="{% static 'main.js' %}"></script>
<!-- ================================================== -->

</body>
</html>